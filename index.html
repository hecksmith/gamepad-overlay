<!DOCTYPE html>
<html>
  <head>
    <title>Single-Stick Overlay</title>
    <meta charset="UTF-8" />
    <!--
      NOTE: Set current stick and deadzone in the URL, e.g.
      https://<the-url>?stick=left&deadzone=0.5
    -->
    <style>
      * {
        margin: 0;
        padding: 0;
      }

      html,
      body {
        position: relative;
        background: transparent;
      }

      td {
        vertical-align: middle;
      }

      .info {
        position: absolute;
        right: 0;
        z-index: 1;
        font-weight: 400;
        font-size: 1.5em;
        font-family: monospace;
      }

      .status,
      .stick {
        padding: 6px 8px 8px;
        color: #fff;
        background-color: #222;
      }

      .stick + .stick {
        margin-top: 10px;
      }

      .vals {
        width: 5rem;
        text-align: right;
      }
    </style>
  </head>

  <body>
    <div class="info">
      <div id="status" class="status"></div>
      <div id="stats"></div>
    </div>

    <canvas id="canvas" width="500" height="500"></canvas>

    <script type="module">
      import "./joypad.min.js";
      import throttle from "./lodash.throttle@4.1.1.min.js";

      // Default gamepad config
      const DEFAULT_STICK = "right";
      const DEFAULT_DEADZONE = 0.01;

      // Visual config
      const RADIUS = 100;
      const MARGIN = 10; // margin between two sticks

      // Get any custom configuration from URL query params
      const PARAMS = new URLSearchParams(window.location.search);
      const STICK = PARAMS.get("stick") || DEFAULT_STICK;
      const DEADZONE = PARAMS.get("deadzone") ? Number(PARAMS.get("deadzone")) : DEFAULT_DEADZONE;

      // prettier-ignore
      const sticksToDisplay = (STICK === "left" || STICK === "right")
        ? [STICK]
        : ["left", "right"];

      // Elements
      const $id = document.getElementById.bind(document);
      const ctx = $id("canvas").getContext("2d");
      const $stats = $id("stats");
      const $status = $id("status");

      // Throttle draw function to 60fps
      const drawThrottled = throttle(draw, 16, { trailing: true });

      // Global state, shared by drawing functions
      let isConnected = false;

      const STATE = {
        left: { x: 0, y: 0 },
        right: { x: 0, y: 0 },
      };

      // Wire up!
      const DIR_TO_AXIS = { left: "x", right: "x", top: "y", bottom: "y" };

      joypad.set({ axisMovementThreshold: 0.01 });

      joypad.on("axis_move", ({ detail }) => {
        // NOTE: `detail.stickMoved` is either `left_stick` or `right_stick`
        const whichMoved = detail.stickMoved.split("_")[0];

        if (sticksToDisplay.includes(whichMoved)) {
          const axis = DIR_TO_AXIS[detail.directionOfMovement];

          STATE[whichMoved][axis] = applyDeadZoneAndFormatValue(detail.axisMovementValue);
          drawThrottled();
        }
      });

      joypad.on("connect", handleConnect);
      joypad.on("disconnect", handleDisconnect);

      handleDisconnect();

      // Rendering

      function draw() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);

        sticksToDisplay.forEach((s) => drawStick(s));
        drawStats();
      }

      function drawStick(stick) {
        // prettier-ignore
        const offset = sticksToDisplay.length > 1 && stick === "right"
          ? RADIUS * 2 + MARGIN
          : 0;

        // Background
        circle(RADIUS + offset, RADIUS, RADIUS, "#222");

        // Position
        const x = Number(STATE[stick].x) * RADIUS + RADIUS + offset;
        const y = Number(STATE[stick].y) * RADIUS + RADIUS;

        const dotColor = stick === "right" ? "red" : "#55aaff";
        circle(x, y, RADIUS / 10, dotColor);

        // Center point
        circle(RADIUS + offset, RADIUS, 1, "white");

        // Lines
        /*
        const len = 3;
        ctx.lineWidth = 1;
        ctx.strokeStyle = "#eee";
        line(RADIUS, 0, RADIUS, len);
        line(RADIUS, RADIUS * 2, RADIUS, RADIUS * 2 - len);
        line(0, RADIUS, len, RADIUS);
        line(RADIUS * 2, RADIUS, RADIUS * 2 - len, RADIUS);
        */
      }

      function line(fromX, fromY, toX, toY) {
        ctx.beginPath();
        ctx.moveTo(fromX, fromY);
        ctx.lineTo(toX, toY);
        ctx.stroke();
      }

      function drawStats() {
        // Ensure the disconnected message is cleared on any stats update
        if (!isConnected) {
          handleConnect();
          isConnected = true;
        }

        // prettier-ignore
        const html = sticksToDisplay.map((stick) => `
          <div class="stick">
            <table>
              <tr>
                <td>x:</td>
                <td class="vals">${STATE[stick].x}</td>
              </tr>
              <tr>
                <td>y:</td>
                <td class="vals">${STATE[stick].y}</td>
              </tr>
            </table>
          </div>
        `).join("");

        $stats.innerHTML = html;
      }

      function handleDisconnect() {
        isConnected = false;
        $status.innerText = "No controller!";
        $status.style.display = "block";
      }

      function handleConnect() {
        isConnected = true;
        $status.style.display = "none";
      }

      // Helpers

      function circle(x, y, radius, fillStyle) {
        ctx.beginPath();
        ctx.arc(x, y, radius, 0, 2 * Math.PI);
        ctx.fillStyle = fillStyle;
        ctx.fill();
      }

      // prettier-ignore
      function applyDeadZoneAndFormatValue(value) {
        return ((value > 0 && value > DEADZONE) || (value < 0 && value < (DEADZONE *-1)))
          ? value.toFixed(2)
          : 0;
      }
    </script>
  </body>
</html>
